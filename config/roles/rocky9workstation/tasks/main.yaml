# TODO Add doom emacs install
# TODO Add ohmyzsh install
# TODO Add ohmytmux install
# TODO Add SauceCodePro install
# TODO Add XRDP config to launch i3
# TODO Migrate VM's to config

- name: Install packages
  ansible.builtin.dnf:
    name:
      - vim
      - cowsay
      - dmenu
      - emacs
      - epel-release
      - gh
      - git 
      - i3status
      - neovim
      - podman
      - docker
      - xrdp
      - nano
      - rust
      - nodejs
      - ruby
      - gimp
      - firefox
      - thunar
      - qbittorrent
      - fzf
      - ranger
      - terminator
      - fortune-mod
      - cowsay
      - ranger
      - zsh
      - stow
      - bc
      - tree
      - tmux
      - net-tools
      - nginx
      - qemu-kvm
      - libvirt
      - virt-manager
      - virt-install
      - bridge-utils
      - virt-top
      - libguestfs-tools
      - bridge-utils
      - virt-viewer
    state: latest

- name: list directories
  find:
    paths: "{{ role_path }}file/home/"
    file_type: directory
    hidden: true
    recurse: true
  register: home_directories

- name: create directories
  ansible.builtin.file:
    path: "/home/andrew{{ item.path[5:] }}" 
    state: directory
  loop: "{{ home_directories.files }}"

- name: list files
  find:
    paths: "{{ role_path }}/files/home/"
    file_type: file
    hidden: true
    recurse: true
  register: home_files

- name: Put SELinux in permissive mode, logging actions that would be blocked.
  ansible.posix.selinux:
    policy: targeted
    state: permissive

- name: copy files
  copy:
    src: "{{ item.path }}"
    dest: "/home/andrew{{ item.path[5:] }}" 
  loop: "{{ home_files.files }}"

- name: Create users
  ansible.builtin.user:
    name: "{{ item }}"
    groups: "wheel"
    password: "{{ item | password_hash('sha512') }}"
  loop:
    - andrew
    - silas
    - fei
    - bun
                             
- name: Enable virtualization
  ansible.builtin.systemd_service:
    name: libvirtd
    state: started
    enabled: true 

- name: Define vm from xml and set autostart
  community.libvirt.virt:
    command: define
    xml: "{{ lookup('file', 'vm_template.xml') }}"
    autostart: true

